<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課程檔案中控台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: "Microsoft JhengHei", sans-serif; }
        .filter-section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .filter-group { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .filter-label { font-weight: bold; color: #555; margin-right: 10px; min-width: 50px; }
        .filter-btn { border: 1px solid #dee2e6; color: #555; background: white; border-radius: 20px; padding: 5px 15px; font-size: 0.9rem; transition: all 0.2s; cursor: pointer; user-select: none; }
        .filter-btn:hover { background: #e9ecef; }
        .filter-btn.active { background: #495057; color: white; border-color: #495057; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; height: 100%; overflow: hidden; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        
        /* 標題基礎樣式 */
        .card-header-custom { color: white; padding: 15px; font-weight: bold; border: none; }
        
        /* --- 顏色設定區 --- */
        
        /* 1. 淺紅色系 (1開頭) */
        .header-type-1 { background: linear-gradient(135deg, #ff8a80, #e53935); }
        
        /* 2. 藍色系/Teal (2開頭) */
        .header-type-2 { background: linear-gradient(135deg, #20c997, #0d6efd); }
        
        /* 3. 橘紅系 (3開頭) */
        .header-type-3 { background: linear-gradient(135deg, #ff9f43, #ee5253); }
        
        /* 4. 淺紫色系/Indigo (4開頭) */
        .header-type-4 { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        
        /* 其他 (Fallback) */
        .header-type-default { background: linear-gradient(135deg, #6c757d, #343a40); }
        /* ---------------- */

        .btn-resource { width: 100%; margin-bottom: 8px; text-align: left; position: relative; font-weight: 500; }
        .btn-resource i { margin-right: 8px; width: 20px; text-align: center; }
        
        .tags-container { margin-top: 10px; }
        .badge-custom { background: #e9ecef; color: #495057; font-weight: normal; margin-right: 5px; border: 1px solid #dee2e6; }
        
        #loading { text-align: center; padding: 50px; font-size: 1.2rem; color: #666; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold"><i class="fas fa-archive text-primary me-2"></i>課程檔案中控台</h2>
        <button class="btn btn-outline-secondary btn-sm" onclick="resetFilters()">
            <i class="fas fa-undo me-1"></i> 重置篩選
        </button>
    </div>

    <div class="filter-section" id="filterContainer">
        <div id="loading">正在讀取課程資料庫...</div>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="cardContainer">
        </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.css"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
    // 設定您的 Google Sheet CSV 連結
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSqBhV5bn4baTSoMK03xZstLPc3_tBKc2k9GUmfmxWvMpHsJm84lGAA48YrC_-I3yvoDem9w-EjvNQa/pub?gid=1957980200&single=true&output=csv';

    let allData = [];
    let activeFilters = {};

    // 欄位對應
    const COL_TITLE = 3;  // D欄 課程檔案
    const COL_TAGS = [6, 9, 10, 11, 12]; // G, J, K, L, M
    const TAG_NAMES = { 6:'主題', 9:'對象', 10:'時數', 11:'形式', 12:'難度' }; 
    
    // 連結欄位 (U, V, W)
    const COL_LINK_PPT = 20; // U欄
    const COL_LINK_DOC = 21; // V欄
    const COL_LINK_MAT = 22; // W欄

    // 1. 初始化：讀取 CSV
    Papa.parse(csvUrl, {
        download: true,
        header: false,
        complete: function(results) {
            const rows = results.data;
            
            // 設定只讀取 row 2 到 row 80 (index 1 ~ 79)
            // 避免讀取到第 80 列以後的雜訊
            let rawData = rows.slice(1, 80); 

            // 過濾掉標題是空的行
            allData = rawData.filter(row => row[COL_TITLE] && row[COL_TITLE].trim() !== '');
            
            initFilters();
            renderCards(allData);
            document.getElementById('loading').style.display = 'none';
        },
        error: function(err) {
            document.getElementById('loading').innerHTML = '<span class="text-danger">讀取失敗，請檢查網路或連結。</span>';
            console.error(err);
        }
    });

    // 2. 初始化篩選器
    function initFilters() {
        const container = document.getElementById('filterContainer');
        container.innerHTML = ''; 

        COL_TAGS.forEach(colIndex => {
            const uniqueValues = [...new Set(allData.map(row => row[colIndex]))].filter(v => v).sort();
            
            if (uniqueValues.length > 0) {
                const group = document.createElement('div');
                group.className = 'filter-group';
                
                const label = document.createElement('span');
                label.className = 'filter-label';
                label.innerText = TAG_NAMES[colIndex] + "：";
                group.appendChild(label);

                uniqueValues.forEach(val => {
                    const btn = document.createElement('div');
                    btn.className = 'filter-btn';
                    btn.innerText = val;
                    btn.onclick = () => toggleFilter(colIndex, val, btn);
                    group.appendChild(btn);
                });
                container.appendChild(group);
            }
        });
    }

    // 3. 切換篩選狀態
    function toggleFilter(colIndex, val, btn) {
        if (!activeFilters[colIndex]) activeFilters[colIndex] = [];

        const index = activeFilters[colIndex].indexOf(val);
        if (index === -1) {
            activeFilters[colIndex].push(val); 
            btn.classList.add('active');
        } else {
            activeFilters[colIndex].splice(index, 1); 
            btn.classList.remove('active');
        }
        
        if (activeFilters[colIndex].length === 0) delete activeFilters[colIndex];
        filterData();
    }

    // 4. 執行篩選
    function filterData() {
        const filtered = allData.filter(row => {
            return Object.keys(activeFilters).every(colIndex => {
                return activeFilters[colIndex].includes(row[colIndex]);
            });
        });
        renderCards(filtered);
    }

    // 5. 重置按鈕
    function resetFilters() {
        activeFilters = {};
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        renderCards(allData);
    }

    // 6. 渲染卡片 (包含顏色判斷)
    function renderCards(data) {
        const container = document.getElementById('cardContainer');
        container.innerHTML = '';

        if (data.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-muted py-5">沒有符合條件的課程檔案</div>';
            return;
        }

        data.forEach(row => {
            // --- 顏色判斷邏輯 ---
            const title = row[COL_TITLE];
            const firstChar = title.trim().charAt(0); // 抓取第一個字
            
            let headerClass = 'header-type-default'; // 預設
            
            if (firstChar === '1') {
                headerClass = 'header-type-1'; // 淺紅
            } else if (firstChar === '2') {
                headerClass = 'header-type-2'; // 藍/Teal
            } else if (firstChar === '3') {
                headerClass = 'header-type-3'; // 橘紅
            } else if (firstChar === '4') {
                headerClass = 'header-type-4'; // 淺紫
            }
            // ------------------

            let tagsHtml = '';
            COL_TAGS.forEach(colIndex => {
                if(row[colIndex]) tagsHtml += `<span class="badge badge-custom">${row[colIndex]}</span>`;
            });

            let buttonsHtml = '';
            if (row[COL_LINK_PPT] && row[COL_LINK_PPT].startsWith('http')) {
                buttonsHtml += `<a href="${row[COL_LINK_PPT]}" target="_blank" class="btn btn-outline-primary btn-resource"><i class="far fa-file-powerpoint"></i> 課程簡報</a>`;
            }
            if (row[COL_LINK_DOC] && row[COL_LINK_DOC].startsWith('http')) {
                buttonsHtml += `<a href="${row[COL_LINK_DOC]}" target="_blank" class="btn btn-outline-success btn-resource"><i class="far fa-file-alt"></i> 課程講義</a>`;
            }
            if (row[COL_LINK_MAT] && row[COL_LINK_MAT].startsWith('http')) {
                buttonsHtml += `<a href="${row[COL_LINK_MAT]}" target="_blank" class="btn btn-outline-warning btn-resource text-dark"><i class="fas fa-book"></i> 參考教材</a>`;
            }
            if (buttonsHtml === '') {
                buttonsHtml = '<div class="text-muted small text-center py-2">尚無連結資料</div>';
            }

            const card = `
                <div class="col">
                    <div class="card h-100">
                        <div class="card-header-custom ${headerClass}">
                            ${title}
                        </div>
                        <div class="card-body">
                            ${buttonsHtml}
                            <div class="tags-container pt-2 border-top mt-3">
                                ${tagsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });
    }
</script>

</body>
</html>
